# 本地模型集成方案 - 工作计划

## TL;DR

> **Quick Summary**: 为 Electron IDE 实现3个本地AI模型的集成系统，支持项目索引、代码分析和上下文总结功能。
> 
> **Deliverables**:
> - 模型调度器（智能路由）
> - 分块处理器（大项目支持）
> - IPC 通信协议
> - UI 控制面板
> 
> **Estimated Effort**: Medium（2-3周）
> **Parallel Execution**: YES - 3 waves
> **Critical Path**: 调度器 → IPC → UI集成

---

## Context

### Original Request
用户希望为 Electron IDE 实现 AI 自动总结上下文并汇总项目进度的功能，采用3个本地模型协作：

1. **Llama 3.2 3B** - 索引生成
2. **Phi-4-mini 3.8B** - 深度分析
3. **Qwen3-4B** - 上下文总结

### Interview Summary

**Key Discussions**:
- 功能模式：汇总/编译/规划/查询/默认 5种模式
- 分块处理：超过100K tokens时需要分块
- 目录索引：需要支持项目结构分析和依赖图谱

**Technical Decisions**:
- 模型运行时：用户自选（推荐Ollama）
- 存储预算：8-10GB（Q4量化）
- 上下文窗口：最大128K（Phi-4-mini）

### Model Configuration

| 模型 | 参数 | 存储(Q4) | 上下文 | 用途 |
|------|------|----------|--------|------|
| Llama 3.2 3B | 3B | ~2GB | 128K | 索引生成 |
| Phi-4-mini | 3.8B | ~3GB | 128K | 深度分析 |
| Qwen3-4B | 4B | ~3GB | 32K+ | 上下文总结 |

---

## Work Objectives

### Core Objective
实现一个智能的多模型调度系统，根据用户选择的模式自动路由到合适的本地模型，支持小项目的即时处理和大项目的分块处理。

### Concrete Deliverables
- `src/main/model/` - 模型调度器和客户端
- `src/main/indexer/` - 分块处理器和索引管理
- `src/main/ipc/` - IPC 通信协议
- `src/renderer/components/AI/` - UI 组件
- `src/shared/types/model.ts` - 类型定义

### Definition of Done
- [ ] 3个模型均可独立调用
- [ ] 5种模式正确路由
- [ ] 100+文件项目能正常分块处理
- [ ] 索引结果可缓存和增量更新
- [ ] 内存稳定，无泄漏

### Must Have
- 智能模型调度（auto模式）
- 分块处理大项目
- 结构化索引输出
- 进度反馈

### Must NOT Have (Guardrails)
- 不要硬编码模型路径
- 不要在渲染进程直接调用模型
- 不要阻塞主线程
- 避免重复索引相同内容

---

## Verification Strategy

### Test Decision
- **Infrastructure exists**: 需检查项目是否有测试框架
- **Automated tests**: TDD推荐
- **Framework**: Jest / Vitest

### QA Policy
每个任务包含 Agent-Executed QA Scenarios。

---

## Execution Strategy

### Parallel Execution Waves

```
Wave 1 (基础设施 - 可并行):
├── Task 1: 类型定义和接口 [quick]
├── Task 2: 模型客户端封装 [quick]
├── Task 3: IPC 协议定义 [quick]
└── Task 4: 配置管理 [quick]

Wave 2 (核心逻辑 - 部分并行):
├── Task 5: 模型调度器 [deep]
├── Task 6: 分块处理器 [deep]
├── Task 7: 索引管理器 [unspecified-high]
└── Task 8: IPC 处理函数 [quick]

Wave 3 (UI集成 - 可并行):
├── Task 9: 模式选择器组件 [visual-engineering]
├── Task 10: 进度指示器 [visual-engineering]
├── Task 11: 结果展示面板 [visual-engineering]
└── Task 12: 设置面板 [visual-engineering]

Wave 4 (集成测试):
├── Task 13: 端到端测试 [deep]
├── Task 14: 性能优化 [unspecified-high]
└── Task 15: 文档编写 [writing]

Wave FINAL (验证):
├── F1: 功能完整性检查
├── F2: 代码质量审查
├── F3: 实际场景测试
└── F4: 范围一致性检查
```

---

## TODOs

### Wave 1: 基础设施

- [ ] 1. 类型定义和接口设计

  **What to do**:
  - 创建 `src/shared/types/model.ts` 定义所有接口
  - 包含：ModelConfig, SchedulerOptions, ProjectIndex, IPC消息类型
  - 确保类型完整且自描述

  **Acceptance Criteria**:
  - [ ] 所有接口有完整 TypeScript 类型
  - [ ] 包含 JSDoc 注释
  - [ ] 无 `any` 类型

  **Recommended Agent Profile**:
  - **Category**: `quick`
  - **Skills**: 无特殊要求

  **Parallelization**:
  - **Can Run In Parallel**: YES
  - **Parallel Group**: Wave 1
  - **Blocks**: Task 5, 6, 8

---

- [ ] 2. 模型客户端封装

  **What to do**:
  - 创建 `src/main/model/client.ts`
  - 实现 OllamaClient 类
  - 支持流式输出、健康检查、超时重试

  **Acceptance Criteria**:
  - [ ] 可调用 `ollama run` API
  - [ ] 支持流式响应
  - [ ] 错误处理完善

  **Recommended Agent Profile**:
  - **Category**: `quick`
  - **Skills**: 无特殊要求

  **Parallelization**:
  - **Can Run In Parallel**: YES
  - **Parallel Group**: Wave 1
  - **Blocks**: Task 5

---

- [ ] 3. IPC 协议定义

  **What to do**:
  - 创建 `src/main/ipc/channels.ts`
  - 定义所有 IPC 通道名称
  - 定义消息格式

  **Acceptance Criteria**:
  - [ ] 渲染进程→主进程通道定义完整
  - [ ] 主进程→渲染进程通道定义完整
  - [ ] 类型安全

  **Recommended Agent Profile**:
  - **Category**: `quick`
  - **Skills**: 无特殊要求

  **Parallelization**:
  - **Can Run In Parallel**: YES
  - **Parallel Group**: Wave 1
  - **Blocks**: Task 8

---

- [ ] 4. 配置管理

  **What to do**:
  - 创建 `src/main/config/model.ts`
  - 读取/保存模型配置
  - 支持用户自定义模型路径

  **Acceptance Criteria**:
  - [ ] 配置可持久化
  - [ ] 有默认值
  - [ ] 类型安全

  **Recommended Agent Profile**:
  - **Category**: `quick`
  - **Skills**: 无特殊要求

  **Parallelization**:
  - **Can Run In Parallel**: YES
  - **Parallel Group**: Wave 1
  - **Blocks**: Task 5

---

### Wave 2: 核心逻辑

- [ ] 5. 模型调度器

  **What to do**:
  - 创建 `src/main/model/scheduler.ts`
  - 实现 ModelScheduler 类
  - 根据任务类型和上下文大小智能路由
  - 实现自动模式逻辑

  **调度逻辑**:
  ```
  auto 模式:
    contextSize < 10K → Qwen3-4B
    contextSize 10K-100K → Phi-4-mini
    contextSize > 100K → 分块处理
  
  plan 模式:
    Llama 3.2 索引 → Phi-4-mini 分析
  ```

  **Acceptance Criteria**:
  - [ ] 5种模式正确路由
  - [ ] 自动判断逻辑正确
  - [ ] 有单元测试

  **Recommended Agent Profile**:
  - **Category**: `deep`
  - **Skills**: 无特殊要求

  **Parallelization**:
  - **Can Run In Parallel**: NO (依赖 Task 1, 2, 4)
  - **Blocks**: Task 8, 13

---

- [ ] 6. 分块处理器

  **What to do**:
  - 创建 `src/main/indexer/chunk.ts`
  - 实现按目录/模块分块算法
  - 确保语义完整性
  - 实现合并策略

  **Acceptance Criteria**:
  - [ ] 单块不超过50K tokens
  - [ ] 不切分函数/类
  - [ ] 可正确合并结果

  **Recommended Agent Profile**:
  - **Category**: `deep`
  - **Skills**: 无特殊要求

  **Parallelization**:
  - **Can Run In Parallel**: NO (依赖 Task 1)
  - **Blocks**: Task 7, 13

---

- [ ] 7. 索引管理器

  **What to do**:
  - 创建 `src/main/indexer/manager.ts`
  - 管理索引生命周期
  - 实现缓存和增量更新
  - 索引持久化

  **Acceptance Criteria**:
  - [ ] 索引可保存到磁盘
  - [ ] 增量更新正常工作
  - [ ] 缓存命中时有提示

  **Recommended Agent Profile**:
  - **Category**: `unspecified-high`
  - **Skills**: 无特殊要求

  **Parallelization**:
  - **Can Run In Parallel**: NO (依赖 Task 6)
  - **Blocks**: Task 13

---

- [ ] 8. IPC 处理函数

  **What to do**:
  - 创建 `src/main/ipc/handlers.ts`
  - 实现所有 IPC 请求的处理函数
  - 连接调度器和索引管理器

  **Acceptance Criteria**:
  - [ ] 所有通道有处理函数
  - [ ] 错误正确传递到渲染进程
  - [ ] 进度更新正常发送

  **Recommended Agent Profile**:
  - **Category**: `quick`
  - **Skills**: 无特殊要求

  **Parallelization**:
  - **Can Run In Parallel**: NO (依赖 Task 3, 5)
  - **Blocks**: Task 9-12

---

### Wave 3: UI集成

- [ ] 9. 模式选择器组件

  **What to do**:
  - 创建 `src/renderer/components/AI/ModeSelector.tsx`
  - 5个模式按钮
  - 快捷键支持

  **Acceptance Criteria**:
  - [ ] 视觉清晰
  - [ ] 当前选中状态明显
  - [ ] 快捷键正常工作

  **Recommended Agent Profile**:
  - **Category**: `visual-engineering`
  - **Skills**: `frontend-ui-ux`

  **Parallelization**:
  - **Can Run In Parallel**: YES
  - **Parallel Group**: Wave 3
  - **Blocks**: Task 13

---

- [ ] 10. 进度指示器

  **What to do**:
  - 创建 `src/renderer/components/AI/ProgressIndicator.tsx`
  - 显示任务进度
  - 分块进度（N/M）
  - 模型加载状态

  **Acceptance Criteria**:
  - [ ] 进度准确
  - [ ] 动画流畅
  - [ ] 可取消

  **Recommended Agent Profile**:
  - **Category**: `visual-engineering`
  - **Skills**: `frontend-ui-ux`

  **Parallelization**:
  - **Can Run In Parallel**: YES
  - **Parallel Group**: Wave 3
  - **Blocks**: Task 13

---

- [ ] 11. 结果展示面板

  **What to do**:
  - 创建 `src/renderer/components/AI/ResultPanel.tsx`
  - 树形结构展示索引
  - Markdown 渲染报告
  - 错误信息展示

  **Acceptance Criteria**:
  - [ ] 索引可展开/折叠
  - [ ] Markdown 正确渲染
  - [ ] 可复制结果

  **Recommended Agent Profile**:
  - **Category**: `visual-engineering`
  - **Skills**: `frontend-ui-ux`

  **Parallelization**:
  - **Can Run In Parallel**: YES
  - **Parallel Group**: Wave 3
  - **Blocks**: Task 13

---

- [ ] 12. 设置面板

  **What to do**:
  - 创建 `src/renderer/components/AI/SettingsPanel.tsx`
  - 模型运行时配置
  - 模型下载管理
  - 性能参数调整

  **Acceptance Criteria**:
  - [ ] 配置可保存
  - [ ] 下载进度显示
  - [ ] 参数验证

  **Recommended Agent Profile**:
  - **Category**: `visual-engineering`
  - **Skills**: `frontend-ui-ux`

  **Parallelization**:
  - **Can Run In Parallel**: YES
  - **Parallel Group**: Wave 3
  - **Blocks**: Task 13

---

### Wave 4: 集成测试

- [ ] 13. 端到端测试

  **What to do**:
  - 测试完整工作流
  - 测试各模式切换
  - 测试大项目分块

  **Acceptance Criteria**:
  - [ ] 所有模式正常工作
  - [ ] 分块处理正确
  - [ ] 错误恢复正常

  **Recommended Agent Profile**:
  - **Category**: `deep`

  **Parallelization**:
  - **Can Run In Parallel**: NO (依赖所有前置任务)

---

- [ ] 14. 性能优化

  **What to do**:
  - 模型切换内存管理
  - 缓存策略优化
  - 响应时间优化

  **Acceptance Criteria**:
  - [ ] 内存稳定
  - [ ] 无泄漏
  - [ ] 响应时间 < 3s（首次加载后）

  **Recommended Agent Profile**:
  - **Category**: `unspecified-high`

---

- [ ] 15. 文档编写

  **What to do**:
  - 用户使用文档
  - 配置说明
  - 故障排查指南

  **Acceptance Criteria**:
  - [ ] 中文文档
  - [ ] 包含截图
  - [ ] 有常见问题解答

  **Recommended Agent Profile**:
  - **Category**: `writing`

---

## Final Verification Wave

- [ ] F1. 功能完整性检查
  验证所有 Must Have 功能存在，所有 Must NOT Have 不存在

- [ ] F2. 代码质量审查
  TypeScript 编译通过，无 any，无内存泄漏

- [ ] F3. 实际场景测试
  使用真实项目测试各模式

- [ ] F4. 范围一致性检查
  确保未超出定义范围

---

## Commit Strategy

- **Wave 1**: `feat(model): add type definitions and model client`
- **Wave 2**: `feat(core): implement scheduler and chunk processor`
- **Wave 3**: `feat(ui): add AI control panel components`
- **Wave 4**: `test: add e2e tests and docs`

---

## Success Criteria

### Verification Commands
```bash
# 类型检查
npm run typecheck

# 测试
npm run test

# 构建
npm run build
```

### Final Checklist
- [ ] 3个模型可独立调用
- [ ] 5种模式正确路由
- [ ] 100+文件项目能正常分块处理
- [ ] 索引结果可缓存
- [ ] 内存稳定无泄漏
- [ ] 文档完整
